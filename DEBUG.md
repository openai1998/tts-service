# 火山引擎 TTS 调试工具使用文档

## 概述

火山引擎 TTS 服务集成了全面的调试功能，可以帮助开发者和运维人员排查问题、优化性能，并分析文本处理和音频生成过程。本文档详细介绍了调试工具的配置、使用方法和功能特性。

## 调试功能配置

### 环境变量配置

在 `.env` 文件中配置以下参数来控制调试功能：

```
# 调试模式设置
DEBUG_MODE=true                # 启用调试模式
DEBUG_DIR=DEBUG                # 调试文件保存目录
DEBUG_SAVE_TEXT=true           # 保存请求文本
DEBUG_SAVE_AUDIO=true          # 保存生成的音频
DEBUG_MAX_FILES=100            # 每种类型最大保存文件数
```

### 配置说明

- `DEBUG_MODE`: 总开关，设为 `true` 启用调试功能
- `DEBUG_DIR`: 调试文件保存的根目录
- `DEBUG_SAVE_TEXT`: 是否保存请求文本
- `DEBUG_SAVE_AUDIO`: 是否保存生成的音频
- `DEBUG_MAX_FILES`: 每种类型（文本/音频）最多保存的文件数量

## 调试工具功能

### 1. 原始请求保存

系统会保存以下内容：

- **完全未处理的原始请求文本**：保存 OpenWebUI 或其他客户端发送的原始文本，包括所有 HTML 标签和格式
- **处理后的文本**：保存经过过滤和清理后的文本，这是最终发送给 TTS 引擎的内容
- **请求元数据**：包括时间戳、请求 ID、模型和声音选择等

### 2. 音频数据保存

系统会保存生成的音频文件，便于回听和分析：

- **MP3 格式音频**：保存完整的生成音频
- **文件命名**：使用时间戳和请求 ID 命名，便于与文本请求对应

### 3. 调试界面

访问 `http://localhost:5050/debug` 可以打开调试界面，提供以下功能：

- 调试状态概览
- 文本文件列表和查看功能
- 音频文件列表和在线播放功能

### 4. 调试 API 端点

系统提供以下 API 端点用于调试：

- `/debug/info`: 获取调试配置和状态信息
- `/debug/text/{filename}`: 获取指定文本文件内容
- `/debug/audio/{filename}`: 获取指定音频文件
- `/debug/test`: 测试调试功能是否正常工作

## 使用方法

### 启用调试模式

1. 确保 `.env` 文件中 `DEBUG_MODE=true`
2. 重启服务使配置生效

### 查看调试信息

1. 访问 `http://localhost:5050/debug` 打开调试界面
2. 查看调试状态、文本文件和音频文件

### 分析原始请求

1. 在调试界面中点击文本文件链接
2. 查看 JSON 格式的请求数据，包含：
   - `timestamp`: 请求时间
   - `request_id`: 请求唯一标识
   - `raw_request`: 完全未处理的原始请求文本
   - `filtered_text`: 过滤和清理后的文本

### 测试调试功能

如果怀疑调试功能不正常工作：

1. 访问 `http://localhost:5050/debug/test`
2. 查看返回的诊断信息，包括目录权限和写入测试结果

## 故障排除

### 调试文件夹为空

可能的原因：

1. **权限问题**：目录没有写入权限
   - 解决方法：检查 Docker 容器内目录权限，确保为 777
   - 命令：`docker exec -it <container_id> ls -la /app/DEBUG`

2. **配置未生效**：调试模式未正确启用
   - 解决方法：检查环境变量是否正确设置并重启服务
   - 访问 `/debug/info` 确认配置状态

3. **路径问题**：挂载卷路径不正确
   - 解决方法：检查 Docker 挂载配置，确保 DEBUG 目录正确挂载

### 调试测试

运行调试测试来诊断问题：

```
curl http://localhost:5050/debug/test
```

检查返回的 JSON 数据，特别关注：
- 目录是否存在
- 目录是否可写
- 写入测试是否成功

## 最佳实践

1. **定期清理**：系统会自动保留最新的文件，但建议定期检查并清理不需要的调试文件
2. **生产环境**：在生产环境中建议关闭调试模式，或仅在需要排查问题时临时启用
3. **敏感数据**：注意调试文件可能包含敏感信息，确保适当保护调试目录

## 技术细节

### 文件格式

- 文本文件：JSON 格式，保存在 `DEBUG/text/` 目录
- 音频文件：MP3 格式，保存在 `DEBUG/audio/` 目录

### 文件命名

文件使用以下格式命名：
- 文本：`{timestamp}_{request_id}.json`
- 音频：`{timestamp}_{request_id}.mp3`

其中 `timestamp` 是 Unix 时间戳，`request_id` 是请求的唯一标识。

### 自动清理

系统会自动维护文件数量，当超过 `DEBUG_MAX_FILES` 设置的数量时，会删除最旧的文件。

## 注意事项

1. 启用调试模式会增加系统负载和磁盘使用
2. 调试文件可能包含用户敏感信息，请妥善保管
3. 在高流量环境中，建议适当降低 `DEBUG_MAX_FILES` 值
