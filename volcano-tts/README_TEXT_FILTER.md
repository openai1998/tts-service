# 文本过滤功能使用指南

## 功能介绍

文本过滤功能用于在TTS转换前过滤掉不需要转换为语音的特定内容，例如：

- AI助手返回的引用资料（如OpenWebUI中的`<details>`标签内容）
- 思考过程、参考资料等元信息
- 其他不需要转换为语音的特定内容

通过配置过滤规则，系统可以自动识别并移除这些内容，只将有效内容转换为语音，提高用户体验。

## 配置方法

### 1. 启用过滤功能

在`.env`文件中添加以下配置：

```
# 启用文本过滤功能
TEXT_FILTER_ENABLED=true

# 使用默认过滤规则
TEXT_FILTER_USE_DEFAULT_RULES=true
```

### 2. 默认过滤规则

系统内置了以下默认过滤规则：

1. **详情标签**：过滤`<details><summary>资料[n]: xxx</summary>...</details>`格式的内容
2. **思考过程**：过滤以"思考过程："开头的段落
3. **链接标记**：过滤单独的"Link"行

### 3. 自定义过滤规则

#### 方法一：通过环境变量配置

在`.env`文件中添加：

```
# 自定义过滤规则（JSON格式）
TEXT_FILTER_CUSTOM_RULES=[
  {
    "name": "参考资料",
    "pattern": "参考资料：.*?(?=\\n\\n|$)",
    "description": "过滤参考资料部分",
    "is_regex": true
  },
  {
    "name": "固定文本",
    "pattern": "这段文本不需要转换为语音",
    "description": "过滤特定的固定文本",
    "is_regex": false
  }
]
```

#### 方法二：通过规则文件配置

1. 创建规则文件（例如`filter_rules.json`）：

```json
[
  {
    "name": "参考资料",
    "pattern": "参考资料：.*?(?=\\n\\n|$)",
    "description": "过滤参考资料部分",
    "is_regex": true
  },
  {
    "name": "引用块",
    "pattern": ">\\s.*?(?=\\n\\n|$)",
    "description": "过滤Markdown引用块",
    "is_regex": true
  }
]
```

2. 在`.env`文件中指定规则文件路径：

```
TEXT_FILTER_RULES_FILE=filter_rules.json
```

## 规则格式说明

每条规则包含以下字段：

- **name**：规则名称，用于日志和调试
- **pattern**：匹配模式，可以是正则表达式或普通文本
- **description**：规则描述（可选）
- **is_regex**：是否为正则表达式（true/false）
  - 如果为`true`，pattern将作为正则表达式处理
  - 如果为`false`，pattern将作为普通文本进行精确匹配

## 正则表达式提示

编写正则表达式时，请注意：

1. 在JSON中，反斜杠需要转义，例如`\n`应写为`\\n`
2. 使用`.*?`进行非贪婪匹配，避免匹配过多内容
3. 使用`(?=\n\n|$)`等前瞻断言来限定匹配范围
4. 对于复杂内容，可以使用`re.DOTALL`模式（系统默认启用）

## 测试过滤规则

可以使用提供的测试脚本来验证过滤规则是否正常工作：

```bash
python test_text_filter.py
```

## 日志和调试

启用DEBUG日志级别可以查看详细的过滤信息：

```
LOG_LEVEL=DEBUG
```

系统会记录以下信息：

- 过滤器初始化状态
- 加载的规则数量和详情
- 每次过滤操作的结果（过滤数量、原文本长度、过滤后长度）
- 被过滤内容的详情（规则名称、匹配内容）

## 常见问题

1. **过滤规则不生效**
   - 检查`TEXT_FILTER_ENABLED`是否设置为`true`
   - 检查规则格式是否正确
   - 查看日志了解详细信息

2. **过滤掉了不应该过滤的内容**
   - 调整正则表达式，使用更精确的匹配模式
   - 使用非贪婪匹配`.*?`而不是贪婪匹配`.*`
   - 添加边界条件限制匹配范围

3. **JSON格式错误**
   - 使用JSON验证工具检查格式
   - 注意转义字符的使用
   - 确保每个规则都包含必要的字段
